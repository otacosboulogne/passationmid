<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>CONTRÔLE PASSATION MIDI</title>
  <style>
    :root{
      --ink:#111;
      --muted:#666;
      --line:#1a1a1a;
      --bg:#fff;
      --accent:#000;
      --ok-bg:#e8f5e9;
      --ok-accent:#2e7d32;
      --todo-bg:#ffebee;
      --todo-accent:#c62828;
      --passation-bg:#e8f5e9;
    }
    html,body{height:100%}
    body{
      font-family: Arial, Helvetica, sans-serif;
      color:var(--ink);
      background:var(--bg);
      margin:0;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    .page{
      max-width: 980px;
      margin: 24px auto;
      padding: 24px;
      background: var(--passation-bg);
      border-radius: 10px;
    }
    h1{ text-align:center; letter-spacing:.5px; font-size:24px; margin:0 0 18px; }

    .grid{ display:grid; grid-template-columns: repeat(2,1fr); gap:16px; }
    @media (max-width: 900px){ .grid{ grid-template-columns:1fr; } }

    .block{
      background:#fff; border:2px solid var(--line); border-radius:6px;
      padding:10px 10px 6px; page-break-inside:avoid;
    }
    .block h2{ font-size:16px; margin:0 0 8px; text-transform:uppercase; letter-spacing:.5px; }

    table.check{ border-collapse: collapse; width: 100%; font-size: 13px; color: var(--ink); }
    table.check th, table.check td{ border: 1px solid #ccc; padding: 6px 8px; vertical-align: top; background:#fff; }
    table.check th{ background:#f2f2f2; font-weight: 700; text-align:left; color: var(--ink); }
    table.check th:nth-child(2), table.check th:nth-child(3){ width:92px; text-align:center; }
    table.check td:nth-child(2), table.check td:nth-child(3){ text-align:center; white-space:nowrap; }

    .head-todo{ background: var(--todo-bg)!important; color: var(--todo-accent); border-color: var(--todo-accent)!important; }
    .head-ok{ background: var(--ok-bg)!important; color: var(--ok-accent); border-color: var(--ok-accent)!important; }

    .is-todo td{ background: var(--todo-bg); }
    .is-ok   td{ background: var(--ok-bg); }

    /* Rouge uniquement sur l'intitulé des tâches obligatoires */
    .is-required td:first-child,
    .is-required td:first-child *{
      color: var(--todo-accent)!important;
      font-weight: 700;
    }

    .legend{font-size:12px;color:var(--muted);margin:6px 0 0}

    .notes{
      margin-top: 16px; border:2px solid var(--line); border-radius:6px; padding: 10px; background:#fff;
    }
    .notes h3{margin:0 0 6px;font-size:14px;text-transform:uppercase}
    .notes textarea{width:100%;min-height:90px;border:1px solid #ccc;border-radius:4px;padding:8px;font-family:inherit;font-size:13px}

    .flex{display:flex;gap:12px;flex-wrap:wrap}
    .flex .field{flex:1 1 220px}
    .field label{display:block;font-size:12px;color:#333;margin:8px 0 4px}
    .field input, .field textarea, .field select{width:100%;padding:8px;border:1px solid #ccc;border-radius:4px;font-size:13px}

    /* Radios lisibles */
    .radio-row{display:flex; gap:24px; align-items:center; flex-wrap:wrap}
    .radio-option{display:inline-flex; align-items:center; gap:8px; font-size:14px; color:var(--ink); white-space:nowrap}
    .radio-option input[type="radio"]{ width:16px; height:16px; margin:0; }
    input[type="radio"]{ accent-color: var(--ok-accent); }

    .footer{ display:grid; gap:12px; grid-template-columns: 1fr 1fr; margin-top: 16px; }
    @media (max-width: 700px){.footer{grid-template-columns:1fr}}

    .submitbar{display:flex;gap:12px;align-items:center;justify-content:flex-end;margin-top:18px}
    button[type="submit"]{
      background:#111;color:#fff;border:none;border-radius:6px;padding:10px 16px;font-weight:700;cursor:pointer
    }
    button[type="reset"]{display:none!important}
    input[disabled]{opacity:.35; cursor:not-allowed;}

    .form-message{
      margin-top: 15px;
      padding: 12px;
      border-radius: 6px;
      font-weight: bold;
      text-align: center;
    }
    .form-message.success{ background:#d4edda; color:#155724; border:1px solid #c3e6cb; }
    .form-message.error{ background:#f8d7da; color:#721c24; border:1px solid #f5c6cb; }

    @media print{
      body{background:#fff}
      .page{margin:0;padding:0;background:#fff}
      .submitbar{display:none}
      a[href]:after{content:""}
    }
  </style>
</head>
<body>
  <div class="page">
    <h1>CONTRÔLE PASSATION MIDI</h1>

    <form id="passationForm">
      <div class="grid" id="sections"></div>

      <div class="notes">
        <h3>Commentaires & informations</h3>
        <div class="flex">
          <div class="field" style="flex:1 1 100%">
            <label for="commentaires">Commentaires et informations diverses (Information importante / personnel / incident caisse / technique)</label>
            <textarea id="commentaires" name="commentaires" placeholder="Saisir ici..."></textarea>
          </div>
          <div class="field" style="flex:1 1 100%">
            <label for="ruptures">Préciser ici les prochaines ruptures</label>
            <textarea id="ruptures" name="ruptures" placeholder="Produits à risque de rupture, quantités restantes, etc..."></textarea>
          </div>
        </div>
      </div>

      <div class="footer">
        <div class="block">
          <h2>Informations importantes</h2>
          <div class="flex">
            <div class="field">
              <label for="nombrePertesConception">Nombre de pertes de conception en cuisine durant ton service</label>
              <input id="nombrePertesConception" name="nombrePertesConception" type="number" inputmode="numeric" min="0" step="1" placeholder="0" />
            </div>
            <div class="field">
              <label for="nombreRepasEmployes">Nombre de repas employés donnés dans le service</label>
              <input id="nombreRepasEmployes" name="nombreRepasEmployes" type="number" inputmode="numeric" min="0" step="1" placeholder="0" />
            </div>
            <div class="field" style="flex:1 1 280px">
              <label>La commande sur Inpulse a été validée</label>
              <div class="radio-row" role="radiogroup" aria-label="Commande validée">
                <label class="radio-option"><input type="radio" name="commandeValidee" value="Oui"><span>Oui</span></label>
                <label class="radio-option"><input type="radio" name="commandeValidee" value="Non"><span>Non</span></label>
              </div>
            </div>
            <div class="field" style="flex:1 1 280px">
              <label>Le reporting a été rempli</label>
              <div class="radio-row" role="radiogroup" aria-label="Reporting rempli">
                <label class="radio-option"><input type="radio" name="reportingRempli" value="Oui"><span>Oui</span></label>
                <label class="radio-option"><input type="radio" name="reportingRempli" value="Non"><span>Non</span></label>
              </div>
            </div>
          </div>
        </div>
        
        <div class="block">
          <h2>Informations de passation</h2>
          <div class="flex">
            <div class="field"><label for="date">Date</label><input id="date" name="date" type="date" required /></div>
            <div class="field"><label for="heure">Heure</label><input id="heure" name="heure" type="time" required /></div>
            <div class="field" style="flex:1 1 280px"><label for="respUnique">Nom du responsable</label><input id="respUnique" name="responsable" type="text" required /></div>
          </div>
        </div>
      </div>

      <div class="submitbar">
        <button type="submit">Envoyer la checklist</button>
      </div>
    </form>

    <div id="formMessageContainer"></div>
  </div>

  <!-- Construction dynamique des sections -->
  <script>
    // --- Modèle des sections et tâches (identique à ton code) ---
    const SECTIONS = [
      { title: "Terrasse", tasks: [
        "Sol, tables, chaises",
        "Poubelle",
        "Cendriers vides et disponibles",
        "Sol et surfaces propres"
      ]},
      { title: "Toilettes Clients", tasks: [
        "Papier / savon",
        "Toilettes (cuvette, lunette, rebords)",
        "Odeur",
        "Miroir",
        "Poubelle propre et non pleine",
        "Sèche-mains propre et fonctionnel"
      ]},
      { title: "Cuisine", tasks: [
        "Viandes et suppléments en suffisance",
        "Sauces en suffisance",
        "Frigo rempli",
        "Essuie-mains, savon en suffisance",
        "Poubelles changées",
        "Traçabilité prise",
        "Pertes comptabilisées",
        "Galettes descendues",
        "Rouleaux de papier dans imprimantes",
        "Huile à niveau dans les friteuses",
        "Eau à niveau dans bain-marie",
        "Friteuses filtrées",
        "Filtre friteuse changé",
        "Emballages en suffisance"
      ]},
      { title: "Chambres froides", tasks: [
        "Décongélations préparées",
        "Sauces en double dans meuble froid",
        "CF propres",
        "Caillebotis propres",
        "Étagères propres",
        "Produits remontés / rotation faite",
        "Bacs rouges remplis de frites"
      ]},
      { title: "Salle", tasks: [
        "Sol propre",
        "Tables, pieds de tables, chaises propres",
        "Poubelles propres et non pleines",
        "Musique en marche",
        "Bornes fonctionnelles",
        "Enseigne allumée (si nuit)"
      ]},
      { title: "Comptoir", tasks: [
        "Frigos à boissons remplis",
        "Comptoir desserts rempli",
        "Toppings, nappages, lait en suffisance",
        "Télécommandes, agrafeuse, tampon, téléphone disponibles",
        "DLC contrôlées, signalement si besoin",
        "Meuble O’sucré propre et rangé",
        "Comptoir propre et rangé",
        "Présence pailles/serviettes/gobelets/emballages",
        "Plateaux propres et dressés",
        "Machine à glace propre",
        "Vaisselle propre",
        "Savon, essuie-mains en suffisance",
        "Produits d’entretien en suffisance",
        "Rouleaux pleins dans imprimantes et TPE",
        "Caisse comptée + celle de l'équipier + fond de caisse fait si Glory en panne"
      ]},
      { title: "Réserves", tasks: [
        "Réserve bien rangée",
        "Sol et étagères propres",
        "FIFO / DLC",
        "Disponibilité produits (dès réception après rupture)"
      ]},
      { title: "Étage", tasks: [
        "Sol propre",
        "Toilettes, lavabos, murs propres",
        "Savon, essuie-mains en suffisance",
        "Poubelles non pleines",
        "Miroirs propres"
      ]},
      { title: "Plonge", tasks: [
        "Plonge terminée",
        "Zone et matériel propres",
        "Produits diluer et en suffisance"
      ]},
      { title: "E-Pack Hygiène", tasks: [
        "Nettoyage des postes rempli",
        "Check-list manager remplie"
      ]},
      { title: "Tenue du personnel", tasks: [
        "Complète, propre, repassée",
        "Cheveux attachés",
        "Pas de bijoux sauf alliance",
        "Charlotte, tablier, sur-chaussures en cuisine"
      ]}
    ];

    // Tâches obligatoires = OK uniquement + marquage rouge
    const OK_ONLY = new Map([
      ["Cuisine", new Set([
        "Viandes et suppléments en suffisance",
        "Sauces en suffisance",
        "Essuie-mains, savon en suffisance",
        "Galettes descendues",
        "Rouleaux de papier dans imprimantes",
        "Huile à niveau dans les friteuses",
        "Eau à niveau dans bain-marie",
        "Emballages en suffisance"
      ])],
      ["Salle", new Set(["Bornes fonctionnelles"])],
      ["Réserves", new Set(["Disponibilité produits (dès réception après rupture)"])],
      ["Plonge", new Set(["Produits diluer et en suffisance"])],
      ["Toilettes Clients", new Set(["Papier / savon"])],
      ["Chambres froides", new Set([
        "Décongélations préparées",
        "Produits remontés / rotation faite"
      ])],
      ["Comptoir", new Set([
        "Frigos à boissons remplis",
        "Comptoir desserts rempli",
        "Toppings, nappages, lait en suffisance",
        "DLC contrôlées, signalement si besoin",
        "Plateaux propres et dressés",
        "Rouleaux pleins dans imprimantes et TPE",
        "Caisse comptée + celle de l'équipier + fond de caisse fait si Glory en panne"
      ])],
      ["E-Pack Hygiène", new Set([
        "Nettoyage des postes rempli",
        "Check-list manager remplie"
      ])],
      ["Tenue du personnel", new Set(["Charlotte, tablier, sur-chaussures en cuisine"])]
    ]);

    function isOkOnly(sectionTitle, taskText){
      return OK_ONLY.has(sectionTitle) && OK_ONLY.get(sectionTitle).has(taskText);
    }

    const sectionsRoot = document.getElementById('sections');

    function buildStandardBlock(section){
      const block = document.createElement('section');
      block.className = 'block';

      const h = document.createElement('h2');
      h.textContent = section.title.toUpperCase();

      const table = document.createElement('table');
      table.className = 'check';

      const thead = document.createElement('thead');
      thead.innerHTML = `<tr>
        <th>Tâche</th>
        <th class="head-todo">À FAIRE</th>
        <th class="head-ok">OK</th>
      </tr>`;

      const tbody = document.createElement('tbody');

      section.tasks.forEach((task, tIdx) => {
        const id = `${section.title.replace(/[^a-z0-9]/gi,'_').toLowerCase()}_${tIdx}`;
        const onlyOk = isOkOnly(section.title, task);

        const tr = document.createElement('tr');
        if (onlyOk) tr.classList.add('is-required');

        tr.innerHTML = `
          <td>${task}</td>
          <td>${ onlyOk
                ? `<input type="radio" disabled title="Non disponible pour cette tâche">`
                : `<label class="radio-option"><input type="radio" name="${id}" value="A faire"><span>À faire</span></label>`
              }</td>
          <td><label class="radio-option"><input type="radio" name="${id}" value="OK"><span>OK</span></label></td>
        `;

        tr.addEventListener('change', (e) => {
          if(e.target.name === id){
            tr.classList.remove('is-todo','is-ok');
            if(e.target.value === 'A faire') tr.classList.add('is-todo');
            if(e.target.value === 'OK')      tr.classList.add('is-ok');
          }
        });

        tbody.appendChild(tr);
      });

      table.appendChild(thead);
      table.appendChild(tbody);
      block.appendChild(h);
      block.appendChild(table);
      return block;
    }

    function buildObjectifBlock(){
      const block = document.createElement('section');
      block.className = 'block';

      const h = document.createElement('h2');
      h.textContent = 'OBJECTIF';

      const table = document.createElement('table');
      table.className = 'check';

      const thead = document.createElement('thead');
      thead.innerHTML = `<tr>
        <th>Élément</th>
        <th class="head-ok">Oui</th>
        <th class="head-todo">Non</th>
      </tr>`;

      const tbody = document.createElement('tbody');

      const rows = [
        { label: "Objectif avis Google donné au salarié en caisse", name: "objectifAvisGoogle" },
        { label: "Briefing et débriefing effectués", name: "briefingDebriefing" },
        { label: "Satisfait du service", name: "satisfaitService" }
      ];

      rows.forEach(r => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${r.label}</td>
          <td>
            <label class="radio-option">
              <input type="radio" name="${r.name}" value="Oui"><span>Oui</span>
            </label>
          </td>
          <td>
            <label class="radio-option">
              <input type="radio" name="${r.name}" value="Non"><span>Non</span>
            </label>
          </td>
        `;
        tbody.appendChild(tr);
      });

      table.appendChild(thead);
      table.appendChild(tbody);
      block.appendChild(h);
      block.appendChild(table);
      return block;
    }

    // Génère les sections + insère OBJECTIF après "E-Pack Hygiène"
    SECTIONS.forEach((section) => {
      const block = buildStandardBlock(section);
      sectionsRoot.appendChild(block);
      if (section.title === "E-Pack Hygiène") {
        const objectifBlock = buildObjectifBlock();
        sectionsRoot.appendChild(objectifBlock);
      }
    });
  </script>

  <!-- libs PDF -->
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/html2pdf.js@0.10.1/dist/html2pdf.min.js"></script>

  <!-- Soumission : génération PDF + envoi vers Apps Script -->
  <script>
    const WEBAPP_URL = 'https://script.google.com/macros/s/AKfycbzfVPLdU4OAw-BRb48Y7i_bXMov0J4QSKNZdiYetRghAGSWpVKxFgmJ-NSlUkXXoU9i/exec';

    function blobToBase64(blob){
      return new Promise((resolve) => {
        const reader = new FileReader();
        reader.onloadend = () => resolve(reader.result.split(',')[1]);
        reader.readAsDataURL(blob);
      });
    }

    function showMessage(text, type){
      const c = document.getElementById('formMessageContainer');
      c.innerHTML = '';
      const m = document.createElement('div');
      m.className = 'form-message ' + (type === 'success' ? 'success' : 'error');
      m.textContent = text;
      c.appendChild(m);
    }

    // Empêche l’envoi plus d’une fois (mémoire locale + verrou session)
    function makeKey(meta){
      const d = meta.date || new Date().toISOString().slice(0,10);
      const r = (meta.responsable||'').trim().toLowerCase();
      return `passation-sent-${d}-${r}`;
    }

    let formAlreadySent = false;

    async function makePdfBlob(page){
      // onclone règle les soucis iOS sans changer le visuel de la page
      const opt = {
        margin: 10,
        html2canvas: {
          scale: 2,
          useCORS: true,
          onclone: (doc) => {
            // Neutraliser apparence iOS (évite color(display-p3...))
            const st = doc.createElement('style');
            st.textContent = `
              * { -webkit-appearance: none !important; appearance: none !important; }
              input, select, textarea { background:#fff !important; color:#111 !important; }
              label.radio-option input[type="radio"]{ /* on garde les radios visibles dans l’original, mais on évite les styles natifs */ }
            `;
            doc.head.appendChild(st);

            // Assurer largeur tableau pour le PDF (pas de coupe)
            doc.querySelectorAll('table.check').forEach(t=>{
              t.style.tableLayout = 'fixed';
              t.style.width = '100%';
            });
            doc.querySelectorAll('table.check th:nth-child(2), table.check td:nth-child(2), table.check th:nth-child(3), table.check td:nth-child(3)').forEach(c=>{
              c.style.width = '80px';
              c.style.whiteSpace = 'nowrap';
            });

            // Figer les champs (date/heure/texte) pour l’export
            ['date','time','number','text'].forEach(type=>{
              doc.querySelectorAll(`input[type="${type}"]`).forEach(el=>{
                el.setAttribute('value', el.value || '');
              });
            });
            doc.querySelectorAll('textarea').forEach(t=>{
              const v = t.value || '';
              const repl = doc.createElement('div');
              repl.style.whiteSpace = 'pre-wrap';
              repl.style.border = '1px solid #ccc';
              repl.style.borderRadius = '4px';
              repl.style.padding = '8px';
              repl.textContent = v;
              t.parentNode.replaceChild(repl, t);
            });
          }
        },
        jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
      };
      return await html2pdf().set(opt).from(page).output('blob');
    }

    document.getElementById('passationForm').addEventListener('submit', async (e) => {
      e.preventDefault();

      const form = e.target;
      const submitBtn = form.querySelector('button[type="submit"]');

      const meta = {
        date: form.date.value,
        heure: form.heure.value,
        responsable: (form.respUnique?.value || form.responsable?.value || '').trim()
      };

      // Double envoi : blocage
      const key = makeKey(meta);
      if (formAlreadySent || localStorage.getItem(key)) {
        showMessage("⚠️ Ce formulaire a déjà été envoyé.", "error");
        return;
      }

      submitBtn.disabled = true;
      const page = document.querySelector('.page');
      const submitbar = document.querySelector('.submitbar');
      const prevDisplay = submitbar.style.display;
      submitbar.style.display = 'none';

      try {
        const pdfBlob = await makePdfBlob(page);

        submitbar.style.display = prevDisplay;

        // Nom côté client (affiché dans l’historique Drive, mais le serveur renomme aussi)
        const safeDate = meta.date || new Date().toISOString().slice(0,10);
        const safeHeure = (meta.heure || '').replace(':','-');
        const fileName = `Passation MIDI - ${safeDate} ${safeHeure}${meta.responsable ? ' - ' + meta.responsable : ''}.pdf`;

        const b64 = await blobToBase64(pdfBlob);
        const body = new URLSearchParams({ data: JSON.stringify({ fileName, b64, meta }) });

        const res = await fetch(WEBAPP_URL, { method: 'POST', body });
        if (!res.ok) throw new Error('HTTP ' + res.status);

        const jsonText = await res.text();
        let json; try { json = JSON.parse(jsonText); } catch { throw new Error('Réponse non-JSON'); }
        if (json.status !== 'ok') throw new Error(json.message || 'Erreur serveur');

        // Succès
        formAlreadySent = true;
        localStorage.setItem(key, '1');
        showMessage("✅ Checklist envoyée avec succès !", "success");
        // (on laisse le bouton désactivé)

      } catch (err) {
        submitbar.style.display = prevDisplay;
        console.error(err);
        submitBtn.disabled = false; // réactiver en cas d’échec
        showMessage("❌ Échec de l’envoi : " + err.message, "error");
      }
    });
  </script>
</body>
</html>
