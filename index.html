<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>CONTRÔLE PASSATION MIDI</title>
  <style>
    :root{
      --ink:#111;
      --muted:#666;
      --line:#1a1a1a;
      --bg:#fff;
      --accent:#000;
      --ok-bg:#e8f5e9;
      --ok-accent:#2e7d32;
      --todo-bg:#ffebee;
      --todo-accent:#c62828;
      --passation-bg:#e8f5e9;
    }
    html,body{height:100%}
    body{
      font-family: Arial, Helvetica, sans-serif;
      color:var(--ink);
      background:var(--bg);
      margin:0;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }
    .page{
      max-width: 980px;
      margin: 24px auto;
      padding: 24px;
      background: var(--passation-bg);
      border-radius: 10px;
    }
    h1{ text-align:center; letter-spacing:.5px; font-size:24px; margin:0 0 18px; }
    .grid{ display:grid; grid-template-columns: repeat(2,1fr); gap:16px; }
    @media (max-width: 900px){ .grid{ grid-template-columns:1fr; } }
    .block{
      background:#fff; border:2px solid var(--line); border-radius:6px;
      padding:10px 10px 6px; page-break-inside:avoid;
    }
    .block h2{ font-size:16px; margin:0 0 8px; text-transform:uppercase; letter-spacing:.5px; }
    table.check{ border-collapse: collapse; width: 100%; font-size: 13px; color: var(--ink); }
    table.check th, table.check td{ border: 1px solid #ccc; padding: 6px 8px; vertical-align: top; background:#fff; }
    table.check th{ background:#f2f2f2; font-weight: 700; text-align:left; color: var(--ink); }
    table.check th:nth-child(2), table.check th:nth-child(3){ width:92px; text-align:center; }
    table.check td:nth-child(2), table.check td:nth-child(3){ text-align:center; white-space:nowrap; }
    .head-todo{ background: var(--todo-bg)!important; color: var(--todo-accent); border-color: var(--todo-accent)!important; }
    .head-ok{ background: var(--ok-bg)!important; color: var(--ok-accent); border-color: var(--ok-accent)!important; }
    .is-todo td{ background: var(--todo-bg); }
    .is-ok   td{ background: var(--ok-bg); }
    .is-required td:first-child,
    .is-required td:first-child *{
      color: var(--todo-accent)!important;
      font-weight: 700;
    }
    .legend{font-size:12px;color:var(--muted);margin:6px 0 0}
    .notes{
      margin-top: 16px; border:2px solid var(--line); border-radius:6px; padding: 10px; background:#fff;
    }
    .notes h3{margin:0 0 6px;font-size:14px;text-transform:uppercase}
    .notes textarea{width:100%;min-height:90px;border:1px solid #ccc;border-radius:4px;padding:8px;font-family:inherit;font-size:13px}
    .flex{display:flex;gap:12px;flex-wrap:wrap}
    .flex .field{flex:1 1 220px}
    .field label{display:block;font-size:12px;color:#333;margin:8px 0 4px}
    .field input, .field textarea, .field select{width:100%;padding:8px;border:1px solid #ccc;border-radius:4px;font-size:13px}
    .radio-row{display:flex; gap:24px; align-items:center; flex-wrap:wrap}
    .radio-option{display:inline-flex; align-items:center; gap:8px; font-size:14px; color:var(--ink); white-space:nowrap}
    .radio-option input[type="radio"]{ width:16px; height:16px; margin:0; }
    input[type="radio"]{ accent-color: var(--ok-accent); }
    .footer{ display:grid; gap:12px; grid-template-columns: 1fr 1fr; margin-top: 16px; }
    @media (max-width: 700px){.footer{grid-template-columns:1fr}}
    .submitbar{display:flex;gap:12px;align-items:center;justify-content:flex-end;margin-top:18px}
    button[type="submit"]{
      background:#111;color:#fff;border:none;border-radius:6px;padding:10px 16px;font-weight:700;cursor:pointer
    }
    button[type="reset"]{display:none!important}
    input[disabled]{opacity:.35; cursor:not-allowed;}
    .form-message{
      margin-top: 15px;
      padding: 12px;
      border-radius: 6px;
      font-weight: bold;
      text-align: center;
    }
    .form-message.success{
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }
    .form-message.error{
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }
    @media print{
      body{background:#fff}
      .page{margin:0;padding:0;background:#fff}
      .submitbar{display:none}
      a[href]:after{content:""}
    }
  </style>
</head>
<body>
  <div class="page">
    <h1>CONTRÔLE PASSATION MIDI</h1>
    <form id="passationForm">
      <div class="grid" id="sections"></div>
      <div class="notes">
        <h3>Commentaires & informations</h3>
        <div class="flex">
          <div class="field" style="flex:1 1 100%">
            <label for="commentaires">Commentaires et informations diverses</label>
            <textarea id="commentaires" name="commentaires"></textarea>
          </div>
          <div class="field" style="flex:1 1 100%">
            <label for="ruptures">Préciser les prochaines ruptures</label>
            <textarea id="ruptures" name="ruptures"></textarea>
          </div>
        </div>
      </div>
      <div class="footer">
        <div class="block">
          <h2>Informations importantes</h2>
          <div class="flex">
            <div class="field">
              <label for="nombrePertesConception">Nombre de pertes de conception</label>
              <input id="nombrePertesConception" name="nombrePertesConception" type="number" min="0" />
            </div>
            <div class="field">
              <label for="nombreRepasEmployes">Nombre de repas employés</label>
              <input id="nombreRepasEmployes" name="nombreRepasEmployes" type="number" min="0" />
            </div>
            <div class="field">
              <label>Commande Inpulse validée</label>
              <label class="radio-option"><input type="radio" name="commandeValidee" value="Oui">Oui</label>
              <label class="radio-option"><input type="radio" name="commandeValidee" value="Non">Non</label>
            </div>
            <div class="field">
              <label>Reporting rempli</label>
              <label class="radio-option"><input type="radio" name="reportingRempli" value="Oui">Oui</label>
              <label class="radio-option"><input type="radio" name="reportingRempli" value="Non">Non</label>
            </div>
          </div>
        </div>
        <div class="block">
          <h2>Informations de passation</h2>
          <div class="flex">
            <div class="field"><label for="date">Date</label><input id="date" name="date" type="date" required /></div>
            <div class="field"><label for="heure">Heure</label><input id="heure" name="heure" type="time" required /></div>
            <div class="field"><label for="respUnique">Responsable</label><input id="respUnique" name="responsable" type="text" required /></div>
          </div>
        </div>
      </div>
      <div class="submitbar">
        <button type="submit">Envoyer la checklist</button>
      </div>
    </form>
    <div id="formMessageContainer"></div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/html2pdf.js@0.10.1/dist/html2pdf.min.js"></script>

  <script>
    const WEBAPP_URL = "TON_URL_SCRIPT_ICI";

    function showMessage(text, type) {
      const container = document.getElementById("formMessageContainer");
      container.innerHTML = "";
      const msg = document.createElement("div");
      msg.className = "form-message " + type;
      msg.textContent = text;
      container.appendChild(msg);
    }

    function blobToBase64(blob){
      return new Promise((resolve) => {
        const reader = new FileReader();
        reader.onloadend = () => resolve(reader.result.split(',')[1]);
        reader.readAsDataURL(blob);
      });
    }

    let formAlreadySent = false;

    document.getElementById('passationForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      if (formAlreadySent) {
        showMessage("⚠️ Ce formulaire a déjà été envoyé.", "error");
        return;
      }
      const form = e.target;
      const submitBtn = form.querySelector('button[type="submit"]');
      submitBtn.disabled = true;

      const meta = {
        date: form.date.value,
        heure: form.heure.value,
        responsable: form.respUnique.value.trim()
      };

      const page = document.querySelector('.page');
      const submitbar = document.querySelector('.submitbar');
      const prevDisplay = submitbar.style.display;
      submitbar.style.display = 'none';

      try {
        const opt = {
          margin: 10,
          html2canvas: { scale: 2, useCORS: true },
          jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
        };
        const pdfBlob = await html2pdf().set(opt).from(page).output('blob');
        submitbar.style.display = prevDisplay;

        const safeDate = meta.date || new Date().toISOString().slice(0,10);
        const safeHeure = (meta.heure || '').replace(':','-');
        const fileName = `Passation MIDI - ${safeDate} ${safeHeure} - ${meta.responsable}.pdf`;

        const b64 = await blobToBase64(pdfBlob);
        const body = new URLSearchParams({ data: JSON.stringify({ fileName, b64, meta }) });

        const res = await fetch(WEBAPP_URL, { method: 'POST', body });
        if (!res.ok) throw new Error('HTTP ' + res.status);
        const json = await res.json();

        if (json.status !== 'ok') throw new Error(json.message || 'Erreur serveur');

        formAlreadySent = true;
        showMessage("✅ Checklist envoyée avec succès !", "success");
      } catch (err) {
        submitbar.style.display = prevDisplay;
        submitBtn.disabled = false;
        showMessage("❌ Échec de l’envoi : " + err.message, "error");
      }
    });
  </script>
</body>
</html>
