<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>CONTRÔLE PASSATION</title>
  <meta name="theme-color" content="#000" />
  <style>
    :root{
      --ink:#111; --muted:#666; --line:#e5e5e5; --bg:#fff; --accent:#000;
      --req:#d32f2f; --ok:#2e7d32;
    }
    html,body{height:100%}
    body{
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, sans-serif;
      color:var(--ink); background:var(--bg); margin:0; -webkit-font-smoothing:antialiased;
    }
    .wrap{max-width:820px;margin:0 auto;padding:16px}
    h1{font-size:22px;margin:0 0 8px 0; letter-spacing:.3px}
    .sub{color:var(--muted); font-size:13px; margin-bottom:14px}
    fieldset{border:1px solid var(--line); border-radius:12px; padding:12px; margin:10px 0}
    legend{font-weight:700; padding:0 6px; font-size:14px}
    label{display:block; font-size:14px; margin:10px 0 4px}
    input[type="text"],input[type="number"],input[type="date"],input[type="time"],select,textarea{
      width:100%; font-size:15px; padding:10px 12px; border:1px solid var(--line); border-radius:10px; box-sizing:border-box;
      background:#fafafa;
    }
    textarea{min-height:90px; resize:vertical}
    .grid{display:grid; grid-template-columns:1fr 110px; gap:6px 10px; align-items:center}
    .item{padding:8px 0; border-bottom:1px dashed var(--line); font-size:14px}
    .item:last-child{border-bottom:0}
    .req{color:var(--req); font-weight:700}
    .okchip{color:var(--ok); font-weight:600}
    .actions{position:sticky; bottom:0; background:linear-gradient(180deg, rgba(255,255,255,.2), #fff 60%); padding:14px 0 6px; backdrop-filter:saturate(150%) blur(4px)}
    button{
      width:100%; appearance:none; border:0; border-radius:14px; padding:14px 16px; font-size:16px; font-weight:700;
      background:#000; color:#fff; box-shadow:0 6px 16px rgba(0,0,0,.18); cursor:pointer;
    }
    button:disabled{opacity:.5; cursor:not-allowed}
    .row{display:flex; gap:8px}
    .row>*{flex:1}
    .hint{font-size:12px; color:var(--muted)}
    .radio-line{display:flex; gap:14px; align-items:center; margin-top:6px}
    .tiny{font-size:12px}
    /* Modal */
    .modal{position:fixed; inset:0; display:none; place-items:center; background:rgba(0,0,0,.45); z-index:50; padding:18px}
    .modal.show{display:grid}
    .card{background:#fff; border-radius:16px; padding:22px; max-width:420px; width:100%; text-align:center; box-shadow:0 10px 30px rgba(0,0,0,.2)}
    .card h2{margin:0 0 10px; font-size:22px}
    .card p{margin:0 0 18px; color:#333}
    .okbtn{background:#2e7d32}
    .retrybtn{background:#000}
    .mt8{margin-top:8px}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>CONTRÔLE PASSATION</h1>
    <div class="sub">Affichage optimisé mobile • Le PDF est archivé par mois sur Drive • Nom de fichier : <b>MM-DD_HH-mm_responsable.pdf</b></div>

    <form id="formPassation" autocomplete="off">
      <fieldset>
        <legend>Informations générales</legend>
        <div class="row">
          <div>
            <label for="date">Date</label>
            <input id="date" name="date" type="date" required />
          </div>
          <div>
            <label for="heure">Heure</label>
            <input id="heure" name="heure" type="time" required />
          </div>
        </div>
        <label for="responsable">Nom du responsable <span class="hint">(obligatoire)</span></label>
        <input id="responsable" name="responsable" type="text" placeholder="Ex. Kma" required />
      </fieldset>

      <fieldset>
        <legend>Informations importantes</legend>
        <div class="row">
          <div>
            <label for="pertes">Pertes de conception cuisine (nb)</label>
            <input id="pertes" name="pertes" type="number" min="0" value="0" />
          </div>
          <div>
            <label for="repasEmp">Repas employés donnés (nb)</label>
            <input id="repasEmp" name="repasEmp" type="number" min="0" value="0" />
          </div>
        </div>

        <label>Commande Inpulse validée ?</label>
        <div class="radio-line tiny">
          <label><input type="radio" name="inpulse" value="Oui" checked> Oui</label>
          <label><input type="radio" name="inpulse" value="Non"> Non</label>
        </div>

        <label class="mt8">Reporting rempli ?</label>
        <div class="radio-line tiny">
          <label><input type="radio" name="reporting" value="Oui" checked> Oui</label>
          <label><input type="radio" name="reporting" value="Non"> Non</label>
        </div>
      </fieldset>

      <fieldset>
        <legend>Checklist – Cuisine</legend>
        <div class="grid">
          <div class="item">Viandes & suppléments en suffisance</div>
          <select name="cui_viandes">
            <option>OK</option><option>À faire</option>
          </select>

          <div class="item">Sauces en suffisance</div>
          <select name="cui_sauces">
            <option>OK</option><option>À faire</option>
          </select>

          <div class="item">Essuie-mains & savon en suffisance</div>
          <select name="cui_essuie">
            <option>OK</option><option>À faire</option>
          </select>

          <div class="item">Galettes descendues</div>
          <select name="cui_galettes">
            <option>OK</option><option>À faire</option>
          </select>

          <div class="item">Rouleaux papier imprimantes</div>
          <select name="cui_rouleaux">
            <option>OK</option><option>À faire</option>
          </select>

          <div class="item">Huile à niveau dans friteuses</div>
          <select name="cui_huile">
            <option>OK</option><option>À faire</option>
          </select>

          <div class="item">Eau à niveau dans bain-marie</div>
          <select name="cui_bainmarie">
            <option>OK</option><option>À faire</option>
          </select>

          <div class="item">Emballages en suffisance</div>
          <select name="cui_emballages">
            <option>OK</option><option>À faire</option>
          </select>
        </div>
      </fieldset>

      <fieldset>
        <legend>Checklist – Salle</legend>
        <div class="grid">
          <div class="item">Bornes fonctionnelles</div>
          <select name="sal_bornes">
            <option>OK</option><option>À faire</option>
          </select>
        </div>
      </fieldset>

      <fieldset>
        <legend>Checklist – Réserves</legend>
        <div class="grid">
          <div class="item req">Disponibilité produits (Caisses, Otter) <span class="tiny">(obligatoire)</span></div>
          <select name="res_dispo" id="res_dispo">
            <option selected>OK</option>
            <option disabled>À faire</option> <!-- À faire désactivé ici -->
          </select>
        </div>
      </fieldset>

      <fieldset>
        <legend>Checklist – Plonge</legend>
        <div class="grid">
          <div class="item">Produits dilués & en suffisance</div>
          <select name="plg_produits">
            <option>OK</option><option>À faire</option>
          </select>
        </div>
      </fieldset>

      <fieldset>
        <legend>Checklist – Toilettes clients</legend>
        <div class="grid">
          <div class="item">Papier / Savon</div>
          <select name="toi_papier">
            <option>OK</option><option>À faire</option>
          </select>
        </div>
      </fieldset>

      <fieldset>
        <legend>Checklist – Chambres froides</legend>
        <div class="grid">
          <div class="item">Décongélations préparées</div>
          <select name="cf_decong">
            <option>OK</option><option>À faire</option>
          </select>

          <div class="item">Produits remontés / rotation faite</div>
          <select name="cf_rotation">
            <option>OK</option><option>À faire</option>
          </select>
        </div>
      </fieldset>

      <fieldset>
        <legend>Checklist – Comptoir</legend>
        <div class="grid">
          <div class="item">Frigos à boissons remplis</div>
          <select name="cpt_frigo">
            <option>OK</option><option>À faire</option>
          </select>

          <div class="item">Comptoir desserts rempli</div>
          <select name="cpt_desserts">
            <option>OK</option><option>À faire</option>
          </select>

          <div class="item">Toppings, nappages, lait en suffisance</div>
          <select name="cpt_toppings">
            <option>OK</option><option>À faire</option>
          </select>
        </div>
      </fieldset>

      <fieldset>
        <legend>Notes</legend>
        <textarea name="notes" placeholder="Observations, incidents, points d’attention…"></textarea>
      </fieldset>

      <div class="actions">
        <button id="btnSend" type="submit">Envoyer la checklist</button>
        <div class="hint">Après envoi : un PDF est créé et archivé automatiquement. Un message “Passation envoyée” s’affiche.</div>
      </div>
    </form>
  </div>

  <!-- Modal succès / erreur -->
  <div id="modal" class="modal" role="dialog" aria-modal="true" aria-labelledby="modaltitle">
    <div class="card">
      <h2 id="modaltitle">Passation envoyée</h2>
      <p id="modaltext">Votre passation a été enregistrée.</p>
      <div class="row">
        <button class="okbtn" onclick="closeModal()">OK</button>
        <button id="retryBtn" class="retrybtn" style="display:none" onclick="retryLast()">Réessayer</button>
      </div>
    </div>
  </div>

  <script>
    // === CONFIG
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxP5Mp2yqQmsjHhuZvIUWsFfuAZB0UzNyYzngbcDT7rk9dSD11d41_tVZV-KUyD4oll/exec";

    // === Helpers
    const $ = s => document.querySelector(s);
    const modal = $('#modal'), modalTitle = $('#modaltitle'), modalText = $('#modaltext'), retryBtn = $('#retryBtn');
    let lastPayload = null; // pour réessayer si échec

    function openModal(title, text, showRetry=false){
      modalTitle.textContent = title;
      modalText.textContent = text;
      retryBtn.style.display = showRetry ? 'block' : 'none';
      modal.classList.add('show');
    }
    function closeModal(){ modal.classList.remove('show'); }
    window.closeModal = closeModal; window.retryLast = async () => { if(lastPayload) await sendPayload(lastPayload); };

    // Pré-remplir date/heure à maintenant
    (function initDateTime(){
      const now = new Date();
      const pad = n => String(n).padStart(2,'0');
      $('#date').value = `${now.getFullYear()}-${pad(now.getMonth()+1)}-${pad(now.getDate())}`;
      $('#heure').value = `${pad(now.getHours())}:${pad(now.getMinutes())}`;
    })();

    // Construit un mini-HTML (compact) pour le PDF
    function buildPdfHTML(data){
      const esc = s => String(s??'').replace(/[&<>]/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;'}[c]));
      function line(label, val, required=false){
        return `<tr><td${required?' style="color:#d32f2f;font-weight:700"':''}>${esc(label)}</td><td style="text-align:right">${esc(val)}</td></tr>`;
      }
      return `
        <meta charset="UTF-8">
        <style>
          body{font-family:Arial,Helvetica,sans-serif;margin:20px;color:#111}
          h1{font-size:20px;margin:0 0 8px}
          .sub{color:#666;font-size:12px;margin-bottom:12px}
          table{width:100%; border-collapse:collapse; font-size:12px}
          td{padding:6px 0; border-bottom:1px dotted #ddd}
          section{margin:12px 0 4px}
          h2{font-size:14px;margin:12px 0 6px}
        </style>
        <h1>Contrôle Passation</h1>
        <div class="sub">Date ${esc(data.date)} — ${esc(data.heure)} • Resp. ${esc(data.responsable)}</div>

        <h2>Informations importantes</h2>
        <table>
          ${line('Pertes conception cuisine', data.pertes)}
          ${line('Repas employés donnés', data.repasEmp)}
          ${line('Commande Inpulse validée', data.inpulse)}
          ${line('Reporting rempli', data.reporting)}
        </table>

        <h2>Cuisine</h2>
        <table>
          ${line('Viandes & suppléments', data.cui_viandes)}
          ${line('Sauces', data.cui_sauces)}
          ${line('Essuie-mains & savon', data.cui_essuie)}
          ${line('Galettes descendues', data.cui_galettes)}
          ${line('Rouleaux papier imprimantes', data.cui_rouleaux)}
          ${line('Huile friteuses', data.cui_huile)}
          ${line('Eau bain-marie', data.cui_bainmarie)}
          ${line('Emballages', data.cui_emballages)}
        </table>

        <h2>Salle</h2>
        <table>
          ${line('Bornes fonctionnelles', data.sal_bornes)}
        </table>

        <h2>Réserves</h2>
        <table>
          ${line('Disponibilité produits (Caisses, Otter)', data.res_dispo, true)}
        </table>

        <h2>Plonge</h2>
        <table>
          ${line('Produits dilués', data.plg_produits)}
        </table>

        <h2>Toilettes clients</h2>
        <table>
          ${line('Papier / Savon', data.toi_papier)}
        </table>

        <h2>Chambres froides</h2>
        <table>
          ${line('Décongélations préparées', data.cf_decong)}
          ${line('Produits remontés / rotation', data.cf_rotation)}
        </table>

        <h2>Comptoir</h2>
        <table>
          ${line('Frigos à boissons', data.cpt_frigo)}
          ${line('Comptoir desserts', data.cpt_desserts)}
          ${line('Toppings / nappages / lait', data.cpt_toppings)}
        </table>

        ${data.notes ? `<h2>Notes</h2><div style="font-size:12px">${esc(data.notes)}</div>` : ''}
      `;
    }

    async function sendPayload(payload){
      lastPayload = payload;
      const btn = $('#btnSend');
      btn.disabled = true;

      try{
        const res = await fetch(SCRIPT_URL, {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body:JSON.stringify(payload)
        });
        const data = await res.json();
        if(data && data.ok){
          openModal('Passation envoyée', 'Votre passation a été enregistrée.', false);
          $('#formPassation').reset();
          // Remettre date/heure courantes après reset
          initDateTime && initDateTime();
        }else{
          openModal('Erreur', (data && data.error) ? String(data.error) : 'Échec de l’envoi.', true);
        }
      }catch(err){
        openModal('Erreur réseau', err.message || 'Impossible d’envoyer.', true);
      }finally{
        btn.disabled = false;
      }
    }

    // Soumission
    document.getElementById('formPassation').addEventListener('submit', async (e)=>{
      e.preventDefault();
      const fd = new FormData(e.target);
      const responsable = (fd.get('responsable')||'').toString().trim();
      if(!responsable){ alert('Veuillez saisir le nom du responsable.'); return; }

      const data = Object.fromEntries(fd.entries());
      const htmlPdf = buildPdfHTML(data);

      const payload = {
        html: htmlPdf,
        responsable: responsable,
        timestamp: Date.now()
      };
      await sendPayload(payload);
    });

    // Forcer hard refresh si besoin: ajouter ?v=2 à l’URL
  </script>
</body>
</html>
